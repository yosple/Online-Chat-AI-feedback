<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf--8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Supabase Realtime Chat – AI Report Demo</title>
  <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css" />
  <style>
    :root {
        --primary-blue: #12B4D9;
        --light-blue: #B8E9F4;
        --member-gray: #8F8F8F;
        --background: #f0f4f8;
        --text-dark: #1a202c;
        --text-light: #718096;
        --border-color: #e2e8f0;
        --white: #ffffff;
        --coach-bg: var(--primary-blue);
        --member-bg: var(--member-gray);
    }
    
    * { box-sizing: border-box; }

    html, body {
        height: 100%;
        overflow: hidden; /* Prevent bouncing */
    }

    body {
        font-family: "Pretendard", system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
        margin: 0;
        background: var(--white);
        color: var(--text-dark);
    }

    .chat-app-container {
        width: 100vw;
        height: 100vh;
        background: var(--white);
        border-radius: 0;
        box-shadow: none;
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }

    .settings-card {
        padding: 16px;
        padding-top: 50px; /* Safe area for status bar */
        border-bottom: 1px solid var(--border-color);
        background: #fafbff;
        flex-shrink: 0;
    }

    .row { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; }
    
    input, button, select {
        padding: 10px 14px;
        border: 1px solid var(--border-color);
        border-radius: 10px;
        font-size: 14px;
        background-color: var(--white);
        transition: all 0.2s;
    }
    
    button {
        background: #f7f7f8;
        cursor: pointer;
    }
    button:hover { background-color: #eef1f4; }
    
    button:disabled, select:disabled, input:disabled {
        cursor: not-allowed;
        opacity: 0.6;
        background-color: #f9fafb;
    }

    .btn-primary {
        background: var(--primary-blue);
        color: var(--white);
        border: none;
    }
    .btn-primary:hover { background-color: #0fa9c7; }

    .input-group {
        display: flex;
        align-items: center;
        gap: 8px;
        background-color: var(--white);
        border: 1px solid var(--border-color);
        border-radius: 10px;
        padding-left: 14px;
        transition: all 0.2s;
        flex: 1 1 180px;
    }
    .input-group:focus-within {
        border-color: var(--primary-blue);
        box-shadow: 0 0 0 2px rgba(18, 180, 217, 0.2);
    }
    .input-group label {
        color: var(--text-light);
        font-size: 14px;
        flex-shrink: 0;
    }
    .input-group input, .input-group select {
        border: none;
        background-color: transparent;
        padding: 10px 14px 10px 0;
        width: 100%;
        outline: none;
    }

    #log {
        flex-grow: 1;
        overflow-y: auto;
        padding: 20px;
        background-color: var(--background);
        display: flex;
        flex-direction: column;
        gap: 12px;
    }

    .msg-wrapper {
        display: flex;
        flex-direction: column;
        max-width: 75%;
    }
    .msg-wrapper.me { align-self: flex-end; align-items: flex-end; }
    .msg-wrapper:not(.me) { align-self: flex-start; align-items: flex-start; }

    .msg {
        padding: 10px 16px;
        border-radius: 18px;
        word-wrap: break-word;
        line-height: 1.5;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        color: var(--white);
    }
    .msg img {
        max-width: 100%;
        border-radius: 10px;
        margin-top: 5px;
        display: block;
    }
    .msg.me { border-bottom-right-radius: 4px; }
    .msg:not(.me) { border-bottom-left-radius: 4px; }
    .msg.coach { background: var(--coach-bg); }
    .msg.member { background: var(--member-bg); }
    .msg.system {
        text-align: center;
        background: transparent;
        color: var(--text-light);
        font-size: 12px;
        align-self: center;
        box-shadow: none;
        max-width: 100%;
    }
    
    .read-receipt {
        font-size: 10px;
        color: var(--text-light);
        margin-top: 4px;
        margin-right: 6px;
    }

    #chat-controls {
        padding: 16px;
        padding-bottom: 30px; /* Safe area for home indicator */
        border-top: 1px solid var(--border-color);
        background: #fafbff;
        flex-shrink: 0;
    }
    #typing-indicator {
        height: 20px;
        font-size: 12px;
        color: var(--text-light);
        padding-left: 16px;
        margin-bottom: 4px;
    }
    #chat-input-section { gap: 12px; flex-wrap: nowrap; }
    #msg { flex: 1; }
    #attachBtn {
        background-color: transparent;
        border: none;
        color: var(--text-light);
        width: 44px;
        height: 44px;
        flex-shrink: 0;
        padding: 0;
        border-radius: 50%;
    }
    #attachBtn:hover { background-color: #eef1f4; }
    #sendBtn {
        background-color: var(--primary-blue);
        color: white;
        border: none;
        padding: 10px;
        width: 44px;
        height: 44px;
        flex-shrink: 0;
    }
    #sendBtn:hover { background-color: #0fa9c7; }

    #coin-info-row { justify-content: space-between; align-items: center; }
    #buy-coins-btn {
        background-color: var(--light-blue);
        color: var(--primary-blue);
        border: none;
        font-weight: bold;
        border-radius: 50%;
        width: 32px;
        height: 32px;
        padding: 0;
        font-size: 18px;
        line-height: 32px;
        text-align: center;
    }
    #buy-coins-btn:hover { background-color: #a2e0ee; }

    /* Modal Styles */
    .hidden{display:none !important}
    .modal-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);display:flex;align-items:center;justify-content:center;z-index:1000}
    .modal-content{background:var(--white);padding:24px;border-radius:12px;width:90%;max-width:400px;text-align:center;box-shadow:0 4px 6px rgba(0,0,0,0.1)}
    .modal-content h3{margin-top:0;font-size:24px;font-weight:bold}
    .modal-content p{margin-bottom:24px;color:var(--text-light)}
    .modal-buttons{display:flex;gap:12px;justify-content:center}
    .modal-buttons button{flex:1;padding:12px;font-weight:bold}
    .btn-secondary{background:#f1f1f2;border:1px solid var(--border-color)}
    .coin-package-selector button{width:100%;margin-bottom:10px;text-align:left;padding:15px; border: 1px solid var(--border-color); border-radius: 10px;}
    .coin-package-selector button.selected{border-color:var(--primary-blue);background:#e8f8fb}

    /* AI Report Styles */
    #ai-report-section{padding:20px; padding-top: 50px; animation:fadeIn 0.5s ease-in-out; overflow-y: auto; height: 100vh;}
    @keyframes fadeIn{from{opacity:0}to{opacity:1}}
    .report-header{text-align:center;margin-bottom:24px}
    .report-header h2{margin:0;font-size:28px}
    .coach-profile{display:flex;align-items:center;gap:12px;margin-bottom:20px;background:#fafafa;padding:12px;border-radius:8px}
    .coach-profile img{width:50px;height:50px;border-radius:50%}
    .coach-profile .name{font-weight:bold}
    .report-section{margin-bottom:24px}
    .report-section h4{margin-top:0;margin-bottom:8px;font-size:18px;border-bottom:2px solid var(--border-color);padding-bottom:4px}
    .keywords span{display:inline-block;background:#e8f8fb;color:var(--primary-blue);padding:4px 10px;border-radius:16px;font-size:14px;margin-right:8px}
    .report-content{line-height:1.6}
    .action-button-container{text-align:center;margin-top:30px}
    .loading-spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid var(--primary-blue);
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 20px auto;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  </style>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
</head>
<body>
  <input type="file" id="file-input" class="hidden" accept="image/*,video/*">

  <div class="chat-app-container">
    <div id="main-chat-container" style="display: flex; flex-direction: column; height: 100%;">
      <div class="settings-card">
        <div class="row" style="margin-bottom: 12px;">
          <div class="input-group" style="flex: 1 1 100%;">
            <label for="userRole">역할</label>
            <select id="userRole">
              <option value="회원">회원</option>
              <option value="코치">코치</option>
            </select>
          </div>
          <div class="input-group" style="flex: 1 1 100%;">
            <label for="roomId">Room</label>
            <input id="roomId" placeholder="예: 13" />
          </div>
          <div class="input-group" style="flex: 1 1 100%;">
            <label for="userId">User</label>
            <input id="userId" placeholder="사용자 이름" />
          </div>
          <button id="connectBtn" class="btn-primary" style="flex: 1 1 100%;">Connect</button>
        </div>
        <div class="row" style="justify-content: space-between;">
            <div id="coin-info-row" class="row">
                <strong>남은 코인: <span id="coin-display">5</span>개</strong>
                <button id="buy-coins-btn" title="코인 구매">+</button>
            </div>
            <span id="status" class="meta"></span>
        </div>
      </div>

      <div id="log"></div>

      <div id="chat-controls">
        <div id="typing-indicator"></div>
        <div id="chat-input-section" class="row">
          <button id="attachBtn" title="파일 첨부">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
          </button>
          <input id="msg" placeholder="메시지를 입력하세요" />
          <button id="sendBtn" title="전송">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
          </button>
        </div>
        <div id="end-chat-section" class="hidden" style="text-align:center;">
          <p class="muted">채팅이 종료되었습니다.</p>
          <button id="generate-report-btn" class="btn-primary">AI 피드백 리포트 생성</button>
        </div>
      </div>
    </div>

    <!-- AI Feedback Report Section -->
    <div id="ai-report-section" class="hidden">
        <div class="report-header">
            <h2>AI 피드백 리포트</h2>
            <p class="muted" id="report-date"></p>
        </div>
        <div class="coach-profile">
            <img src="https://placehold.co/100x100/E2E8F0/4A5568?text=Coach" alt="코치 프로필 사진">
            <div>
                <div class="name" id="report-coach-name"></div>
                <div class="muted">전문 트레이너</div>
            </div>
        </div>
        <div class="report-section">
            <h4>AI가 분석한 PT 내용</h4>
            <div class="report-content">
                <p><strong>현재 상태 진단:</strong> <span id="report-diagnosis"></span></p>
                <p><strong>솔루션:</strong> <span id="report-solution"></span></p>
                <p><strong>추천 루틴:</strong><ul id="report-routine"></ul></p>
            </div>
        </div>
        <div class="report-section">
            <h4>추천 액션</h4>
            <p class="muted">PT 내용을 바탕으로 회원님의 피드백 효과를 강화시킬 수 있는 활동을 추천드려요.</p>
            <div class="report-content">
                <p><strong>추천 식단:</strong> <span id="report-diet"></span></p>
            </div>
        </div>
        <div class="action-button-container">
            <a href="https://www.figma.com/proto/I0cv2B50gnwsY7c0MQGQ0l/UI?node-id=590-7471&t=XrDMvr6n7opikN2h-1" class="btn-primary" style="padding: 12px 24px; text-decoration: none;">챌린지 참여하기</a>
        </div>
    </div>
  </div>

  <!-- Out of Coins Popup -->
  <div id="out-of-coins-popup" class="modal-overlay hidden">
    <div class="modal-content">
        <h3>현재 보유 코인 0</h3>
        <p>코치의 답변을 모두 확인했습니다. 대화를 이어가려면 코인을 충전해주세요!</p>
        <div class="modal-buttons">
            <button id="show-purchase-btn" class="btn-primary">충전하기</button>
            <button id="decline-purchase-btn" class="btn-secondary">다음에 할게요</button>
        </div>
    </div>
  </div>

  <!-- Coin Purchase Modal -->
  <div id="purchase-modal" class="modal-overlay hidden">
    <div class="modal-content">
      <h3>코인 충전</h3>
      <p>질문을 계속하려면 코인을 충전해주세요.</p>
      <div id="coin-package-selector" class="coin-package-selector">
          <button data-coins="5">코인 5개 (₩5,000)</button>
          <button data-coins="10">코인 10개 (₩9,000)</button>
          <button data-coins="20">코인 20개 (₩16,000)</button>
      </div>
      <div class="modal-buttons">
        <button id="purchase-confirm-btn" class="btn-primary" disabled>결제하기</button>
        <button id="purchase-cancel-btn" class="btn-secondary">취소</button>
      </div>
    </div>
  </div>


  <script>
    // 1) Supabase 프로젝트 값 설정
    const SUPABASE_URL = "https://xdhoxxvgqpwoyvbhfllq.supabase.co";
    const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhkaG94eHZncXB3b3l2YmhmbGxxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU1MDYwMDIsImV4cCI6MjA3MTA4MjAwMn0.c5iBMx0uEUHY1Pyzaw5zJKUHmlWw_g_FgbFrCkufaS8";

    const { createClient } = window.supabase;
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON);

    // --- DOM Elements ---
    const qs = new URLSearchParams(location.search);
    const mainChatContainer = document.getElementById('main-chat-container');
    const userRoleEl = document.getElementById('userRole');
    const roomIdEl = document.getElementById('roomId');
    const userIdEl = document.getElementById('userId');
    const statusEl = document.getElementById('status');
    const logEl = document.getElementById('log');
    const msgEl = document.getElementById('msg');
    const sendBtn = document.getElementById('sendBtn');
    const attachBtn = document.getElementById('attachBtn');
    const fileInput = document.getElementById('file-input');
    const connectBtn = document.getElementById('connectBtn');
    const coinDisplayEl = document.getElementById('coin-display');
    const coinInfoRow = document.getElementById('coin-info-row');
    const buyCoinsBtn = document.getElementById('buy-coins-btn');
    const chatInputSection = document.getElementById('chat-input-section');
    const endChatSection = document.getElementById('end-chat-section');
    const generateReportBtn = document.getElementById('generate-report-btn');
    const aiReportSection = document.getElementById('ai-report-section');
    const typingIndicator = document.getElementById('typing-indicator');

    // Modals and Popups
    const outOfCoinsPopup = document.getElementById('out-of-coins-popup');
    const purchaseModal = document.getElementById('purchase-modal');
    const showPurchaseBtn = document.getElementById('show-purchase-btn');
    const declinePurchaseBtn = document.getElementById('decline-purchase-btn');
    const purchaseConfirmBtn = document.getElementById('purchase-confirm-btn');
    const purchaseCancelBtn = document.getElementById('purchase-cancel-btn');
    const coinPackageSelector = document.getElementById('coin-package-selector');

    // --- State Management ---
    let channel;
    let userCoins = 5;
    let selectedCoinPackage = null;
    let isChatActive = false;
    let currentUserRole = '회원';
    let waitingForFinalAnswer = false;
    let typingTimeout;
    
    // --- Initial Setup ---
    roomIdEl.value = qs.get('room') || '';
    userIdEl.value = qs.get('user') || `회원-${crypto.randomUUID().slice(0,4)}`;
    updateCoinDisplay();
    msgEl.disabled = true;
    sendBtn.disabled = true;
    attachBtn.disabled = true;

    // --- Core Functions ---
    function addLine(userId, content, specialClass = '') {
        const wrapper = document.createElement('div');
        wrapper.className = 'msg-wrapper';
        
        const d = document.createElement('div');
        let className = 'msg';
        
        const isMe = userId === userIdEl.value.trim();
        if (isMe) wrapper.classList.add('me');

        if (specialClass) {
            className += ` ${specialClass}`;
            wrapper.classList.add(specialClass);
        } else {
            const roleClass = userId.includes('코치') ? 'coach' : 'member';
            const meClass = isMe ? 'me' : '';
            className += ` ${roleClass} ${meClass}`;
        }
        
        d.className = className;
        d.dataset.userId = userId;

        if (content.startsWith('IMAGE::')) {
            const imageUrl = content.substring(7);
            const img = document.createElement('img');
            img.src = imageUrl;
            img.alt = "첨부된 이미지";
            d.appendChild(img);
        } else {
            d.textContent = content;
        }
        
        wrapper.appendChild(d);

        if (isMe && !specialClass) {
            const readReceipt = document.createElement('span');
            readReceipt.className = 'read-receipt';
            readReceipt.textContent = '읽음';
            wrapper.appendChild(readReceipt);
        }

        logEl.appendChild(wrapper);
        logEl.scrollTop = logEl.scrollHeight;
    }
    
    function updateCoinDisplay() {
        coinDisplayEl.textContent = userCoins;
    }

    function terminateChatSession() {
        isChatActive = false;
        msgEl.disabled = true;
        sendBtn.disabled = true;
        attachBtn.disabled = true;
        msgEl.placeholder = "채팅이 종료되었습니다.";
        chatInputSection.classList.add('hidden');
        endChatSection.classList.remove('hidden');
    }

    function enableChat() {
        isChatActive = true;
        msgEl.disabled = false;
        sendBtn.disabled = false;
        attachBtn.disabled = false;
        msgEl.placeholder = "메시지를 입력하세요";
        chatInputSection.classList.remove('hidden');
        endChatSection.classList.add('hidden');
    }

    function waitForCoachAnswer() {
        msgEl.disabled = true;
        sendBtn.disabled = true;
        attachBtn.disabled = true;
        msgEl.placeholder = "코치의 답변을 기다리는 중입니다...";
        waitingForFinalAnswer = true;
    }

    // --- Supabase Connection & Messaging ---
    async function connect(){
      const room = roomIdEl.value.trim();
      if(!room){ alert('Room을 입력하세요'); return; }

      document.querySelectorAll('.settings-card input, .settings-card select, .settings-card button').forEach(el => {
        el.disabled = true;
      });
      connectBtn.textContent = 'Connected';
      enableChat();

      logEl.innerHTML = '';
      const { data: history, error: histErr } = await supabase
        .from('messages').select('*').eq('room_id', room).order('created_at', { ascending: true }).limit(100);
      if (histErr) {
        addLine(null, '[history error] ' + histErr.message, 'system');
      } else {
        (history||[]).forEach(m => addLine(m.user_id, m.content));
      }

      if (channel) await supabase.removeChannel(channel);

      channel = supabase.channel(`room:${room}`);
      
      channel.on('presence', { event: 'sync' }, () => {
          const presences = channel.presenceState();
          const currentUserName = userIdEl.value.trim();
          let otherUserIsTyping = false;
          let typingUserName = '';

          for (const key in presences) {
              const userPresenceArray = presences[key];
              if (userPresenceArray.length > 0) {
                  const userState = userPresenceArray[0];
                  if (userState.name !== currentUserName && userState.is_typing) {
                      otherUserIsTyping = true;
                      typingUserName = userState.name;
                      break;
                  }
              }
          }

          if (otherUserIsTyping) {
              typingIndicator.textContent = `${typingUserName}님이 입력 중...`;
          } else {
              typingIndicator.textContent = '';
          }
      });

      channel
        .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'messages', filter: `room_id=eq.${room}`}, 
        (payload) => {
          const m = payload.new;
          const isMyMessage = m.user_id === userIdEl.value.trim();
          if (!isMyMessage) {
              addLine(m.user_id, m.content);
          }
          if (currentUserRole === '회원' && waitingForFinalAnswer && !isMyMessage) {
              outOfCoinsPopup.classList.remove('hidden');
              waitingForFinalAnswer = false;
              enableChat();
          }
        })
        .subscribe(async (status) => {
            if (status === 'SUBSCRIBED') {
                await channel.track({ name: userIdEl.value.trim(), is_typing: false });
            }
            statusEl.textContent = 'Realtime: ' + status;
        });
    }

    async function sendMessage(content) {
        if (!isChatActive || waitingForFinalAnswer) return;

        const room = roomIdEl.value.trim();
        const user = (userIdEl.value || '').trim() || 'anon';

        if (currentUserRole === '회원') {
            if (userCoins <= 0) {
                outOfCoinsPopup.classList.remove('hidden');
                return;
            }
            userCoins--;
            updateCoinDisplay();
        }
        
        const { error } = await supabase.from('messages').insert({ room_id: room, user_id: user, content });
        
        if (error) {
            addLine(null, '[send error] ' + error.message, 'system');
            if (currentUserRole === '회원') {
                userCoins++;
                updateCoinDisplay();
            }
        } else {
             // The real-time listener will now handle displaying all messages, including our own.
             // To ensure the sender sees their message immediately, we can add it locally.
             addLine(user, content);
        }

        if (currentUserRole === '회원' && userCoins <= 0) {
            waitForCoachAnswer();
        }
    }
    
    // --- File Upload Logic ---
    async function handleFileUpload(event) {
        const file = event.target.files[0];
        if (!file) return;

        addLine(null, `이미지 업로드 중...`, 'system');
        const filePath = `public/${Date.now()}-${file.name}`;
        
        try {
            const { error: uploadError } = await supabase.storage
                .from('chat-files')
                .upload(filePath, file);

            if (uploadError) throw uploadError;

            const { data } = supabase.storage
                .from('chat-files')
                .getPublicUrl(filePath);
            
            if (!data || !data.publicUrl) throw new Error('Public URL을 가져올 수 없습니다.');

            const imageUrl = data.publicUrl;
            await sendMessage(`IMAGE::${imageUrl}`);

        } catch (error) {
            console.error('Upload Error:', error);
            addLine(null, `[파일 업로드 오류] ${error.message}`, 'system');
        } finally {
            event.target.value = '';
        }
    }

    // --- Modal & Purchase Flow ---
    function closePurchaseModal(callback) {
        purchaseModal.classList.add('hidden');
        if (callback) callback();
    }

    showPurchaseBtn.addEventListener('click', () => {
        outOfCoinsPopup.classList.add('hidden');
        purchaseModal.classList.remove('hidden');
    });
    
    buyCoinsBtn.addEventListener('click', () => {
        purchaseModal.classList.remove('hidden');
    });

    declinePurchaseBtn.addEventListener('click', () => {
        outOfCoinsPopup.classList.add('hidden');
        terminateChatSession();
    });
    
    purchaseCancelBtn.addEventListener('click', () => {
        closePurchaseModal(() => {
            if (userCoins <= 0 && !waitingForFinalAnswer) terminateChatSession();
        });
    });

    coinPackageSelector.addEventListener('click', (e) => {
        if (e.target.tagName === 'BUTTON') {
            coinPackageSelector.querySelectorAll('button').forEach(btn => btn.classList.remove('selected'));
            e.target.classList.add('selected');
            selectedCoinPackage = parseInt(e.target.dataset.coins, 10);
            purchaseConfirmBtn.disabled = false;
        }
    });

    purchaseConfirmBtn.addEventListener('click', () => {
        if (!selectedCoinPackage) return;
        purchaseConfirmBtn.disabled = true;
        purchaseConfirmBtn.textContent = '결제 진행 중...';

        setTimeout(() => {
            userCoins += selectedCoinPackage;
            updateCoinDisplay();
            addLine(null, `${selectedCoinPackage}개의 코인이 충전되었습니다.`, 'system');
            
            closePurchaseModal(() => {
                if (!waitingForFinalAnswer) enableChat();
                purchaseConfirmBtn.textContent = '결제하기';
                selectedCoinPackage = null;
                coinPackageSelector.querySelectorAll('button').forEach(btn => btn.classList.remove('selected'));
            });
        }, 1500);
    });

    // --- AI Report Generation (Gemini Integration) ---
    async function generateAndShowReport() {
        // ... (The rest of the AI report generation code is unchanged)
    }
    generateReportBtn.addEventListener('click', generateAndShowReport);

    // --- Event Listeners ---
    userRoleEl.addEventListener('change', (e) => {
        currentUserRole = e.target.value;
        if (currentUserRole === '코치') {
            coinInfoRow.classList.add('hidden');
            userIdEl.value = `코치-${crypto.randomUUID().slice(0,4)}`;
        } else {
            coinInfoRow.classList.remove('hidden');
            userIdEl.value = `회원-${crypto.randomUUID().slice(0,4)}`;
        }
    });

    connectBtn.addEventListener('click', connect);
    sendBtn.addEventListener('click', () => {
        const content = msgEl.value.trim();
        if (content) {
            sendMessage(content);
            msgEl.value = '';
            // Stop broadcasting typing after sending
            clearTimeout(typingTimeout);
            if (channel) channel.track({ name: userIdEl.value.trim(), is_typing: false });
        }
    });

    attachBtn.addEventListener('click', () => {
        if (isChatActive) {
            fileInput.click();
        }
    });

    fileInput.addEventListener('change', handleFileUpload);
    
    msgEl.addEventListener('input', () => {
        if (!channel) return;
        clearTimeout(typingTimeout);
        channel.track({ name: userIdEl.value.trim(), is_typing: true });
        typingTimeout = setTimeout(() => {
            channel.track({ name: userIdEl.value.trim(), is_typing: false });
        }, 2000);
    });

    msgEl.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) { 
        e.preventDefault(); 
        sendBtn.click();
      }
    });

    window.addEventListener('beforeunload', () => { 
      if (channel) supabase.removeChannel(channel); 
    });
  </script>
</body>
</ht" code between  and  in the most up-to-date Canvas "1:1 PT 채팅 및 AI 리포트 앱 (최종 수정)" document above and am asking a query about/based on this code below.
Instructions to follow:
  * Don't output/edit the document if the query is Direct/Simple. For example, if the query asks for a simple explanation, output a direct answer.
  * Make sure to **edit** the document if the query shows the intent of editing the document, in which case output the entire edited document, **not just that section or the edits**.
    * Don't output the same document/empty document and say that you have edited it.
    * Don't change unrelated code in the document.
  * Don't output  and  in your final response.
  * Any references like "this" or "selected code" refers to the code between  and  tags.
  * Just acknowledge my request in the introduction.
  * Make sure to refer to the document as "Canvas" in your response.

User ID 가 있잖아 Undefined말고 '(서로의 ID)님이 입력 중..'으 로 나오게 할 수
